#!/bin/sh
# Conventional Commits validation hook
# See: https://www.conventionalcommits.org/

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Get the first line (subject)
subject=$(echo "$commit_msg" | head -n1)

# Regex pattern for conventional commits
# Format: type(scope)?: description
# Types: feat, fix, docs, chore, test, refactor, ci, build, perf, style
pattern="^(feat|fix|docs|chore|test|refactor|ci|build|perf|style)(\([a-zA-Z0-9_-]+\))?!?: .+"

# Allow merge commits
if echo "$subject" | grep -qE "^Merge (branch|pull request|remote-tracking branch)"; then
    exit 0
fi

# Allow revert commits
if echo "$subject" | grep -qE "^Revert "; then
    exit 0
fi

# Allow fixup/squash commits (used during interactive rebase)
if echo "$subject" | grep -qE "^(fixup|squash)! "; then
    exit 0
fi

# Validate the commit message
if ! echo "$subject" | grep -qE "$pattern"; then
    echo ""
    echo "ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "Expected format:"
    echo "  <type>(<scope>): <description>"
    echo ""
    echo "Types: feat, fix, docs, chore, test, refactor, ci, build, perf, style"
    echo ""
    echo "Examples:"
    echo "  feat: add new command"
    echo "  fix(commands): handle empty input"
    echo "  docs: update README"
    echo "  feat!: breaking change"
    echo ""
    echo "Your commit message:"
    echo "  $subject"
    echo ""
    echo "See: https://www.conventionalcommits.org/"
    echo ""
    exit 1
fi

exit 0
